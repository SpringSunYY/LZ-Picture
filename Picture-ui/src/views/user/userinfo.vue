<template>
  <div class="user-profile">
    <div class="profile-header">
      <div class="avatar-section">
        <div class="avatar-wrapper">
          <a-avatar
            :size="{ xs: 180, sm: 200, md: 240, lg: 240, xl: 240, xxl: 240 }"
            :src="userInfo?.avatarUrl || '/placeholder.svg?height=240&width=240'"
          />
          <!--          <div class="status-badge" :class="'status-' + user.status">-->
          <!--            {{ getStatusText(user.status) }}-->
          <!--          </div>-->
        </div>
      </div>
      <div class="user-intro">
        <h1 class="user-name">{{ userInfo?.nickName || '未设置昵称' }}</h1>
        <p class="user-occupation">{{ userInfo?.occupation || '未设置职业' }}</p>
        <p class="user-bio">{{ userInfo?.introductory || '这个人很懒，还没有填写个人简介...' }}</p>
        <div class="user-meta">
          <div class="meta-item">
            <span class="meta-icon"><i class="fas fa-mobile-alt"></i></span>
            {{ userInfo?.countryCode ? `${userInfo?.countryCode}` : '' }}
            {{ userInfo?.phone || '未设置' }}
          </div>
          <div class="meta-item">
            <span class="meta-icon"><i class="fas fa-venus-mars"></i></span>
            {{ userInfo?.sex ? getUserSexLabel(userInfo?.sex) : '未知' }}
          </div>
          <div class="meta-item">
            <span class="meta-icon"><i class="fas fa-birthday-cake"></i></span>
            {{ userInfo?.birthday }}
          </div>
          <div class="meta-item">
            <span class="meta-icon"><i class="fas fa-globe"></i></span>
            {{ userInfo?.ipAddress || '未知' }}
          </div>
        </div>
      </div>
    </div>

    <div class="profile-stats">
      <div class="stat-card">
        <div class="stat-value">{{ userInfo?.pointsBalance || 0 }}</div>
        <div class="stat-label">积分余额</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ userInfo?.pointsEarned || 0 }}</div>
        <div class="stat-label">赚取积分</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ userInfo?.pointsUsed || 0 }}</div>
        <div class="stat-label">使用积分</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ userInfo?.rechargeAmount || 0 }}</div>
        <div class="stat-label">充值金额(元)</div>
      </div>
    </div>

    <div class="profile-details">
      <a-tabs default-active-key="1">
        <template #rightExtra>
          <a-button @click="handleUpdateUserInfo">修改信息</a-button>
        </template>
        <a-tab-pane key="1" tab="基本信息">
          <div class="details-grid">
            <!--            <div class="detail-item">-->
            <!--              <div class="detail-label">用户ID</div>-->
            <!--              <div class="detail-value">{{ user.userId }}</div>-->
            <!--            </div>-->
            <div class="detail-item">
              <div class="detail-label">用户名</div>
              <div class="detail-value">{{ userInfo?.userName }}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">昵称</div>
              <div class="detail-value">{{ userInfo?.nickName }}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">职业</div>
              <div class="detail-value">{{ userInfo?.occupation }}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">手机号码</div>
              <div class="detail-value">{{ userInfo?.phone }}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">账户状态</div>
              <div class="detail-value">
                <tags
                  :values="[userInfo?.status ? getUserStatusLabel(userInfo?.status) : '未知']"
                  :colors="['green']"
                />
              </div>
            </div>
            <div class="detail-item">
              <div class="detail-label">性别</div>
              <div class="detail-value">
                <tags
                  :values="[userInfo?.sex ? getUserSexLabel(userInfo?.sex) : '未知']"
                  :colors="['green', 'red']"
                />
              </div>
            </div>
            <div class="detail-item">
              <div class="detail-label">IP属地</div>
              <div class="detail-value">{{ userInfo?.ipAddress }}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">注册时间</div>
              <div class="detail-value">{{ userInfo?.createTime }}</div>
            </div>
          </div>
        </a-tab-pane>
        <a-tab-pane key="2" tab="登录信息">
          <div class="details-grid" v-for="item in userInfo?.loginLogInfoVos" :key="item.infoId">
            <div class="detail-item">
              <div class="detail-label">登录时间</div>
              <div class="detail-value">{{ item?.loginTime }}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">登录方式</div>
              <div class="detail-value">
                <tags
                  :values="[item?.loginType ? getLoginTypeLabel(item.loginType) : '未知']"
                  :colors="['green', 'red']"
                />
              </div>
            </div>
            <div class="detail-item">
              <div class="detail-label">IP属地</div>
              <div class="detail-value">{{ item?.loginLocation || '未知' }}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">IP地址</div>
              <div class="detail-value">{{ item?.ipaddr || '未知' }}</div>
            </div>
          </div>
        </a-tab-pane>
      </a-tabs>
    </div>

    <!--修改用户信息-->
    <a-modal v-model:open="open" :footer="null" :width="600" centered destroyOnClose>
      <!-- 自定义标题插槽 -->
      <template #title>
        <div class="custom-modal-title">
          <span style="color: #1890ff; margin-right: 8px">🚀</span>
          {{ title }}
          <a-tooltip title="请输入您的基本信息">
            <question-circle-outlined class="title-tip-icon" />
          </a-tooltip>
        </div>
      </template>
      <a-form
        :model="formState"
        @finish="handleSubmit"
        ref="formRef"
        labelAlign="left"
        :rules="rules"
        :label-col="{ span: 5 }"
        :wrapper-col="{ span: 18 }"
      >
        <a-form-item label="昵称" name="nickName">
          <a-input
            v-model:value="formState.nickName"
            showCount
            :maxlength="16"
            placeholder="请输入昵称"
          />
        </a-form-item>
        <a-form-item label="性别" name="sex">
          <a-radio-group v-model:value="formState.sex" name="radioGroup">
            <a-radio v-for="dict in u_user_sex" :value="dict.dictValue" :key="dict.dictValue">
              {{ dict.dictLabel }}
            </a-radio>
          </a-radio-group>
        </a-form-item>
        <a-form-item label="职业" name="occupation">
          <a-input
            v-model:value="formState.occupation"
            showCount
            :maxlength="16"
            placeholder="请输入职业"
          />
        </a-form-item>
        <a-form-item label="个人简介" name="introductory">
          <a-textarea
            v-model:value="formState.introductory"
            placeholder="请输入个人简介"
            :rows="5"
            showCount
            :maxlength="512"
          />
        </a-form-item>
        <div class="form-footer">
          <a-button @click="open = false">取消</a-button>
          <a-button type="primary" html-type="submit" :loading="submitting"> 提交</a-button>
        </div>
      </a-form>
    </a-modal>
  </div>
</template>

<script setup lang="ts" name="userinfo">
import { getCurrentInstance, ref } from 'vue'
import { getUserSexLabel, getUserStatusLabel, type MyUserInfo } from '@/types/user/user.d.ts'
import useUserStore from '@/stores/modules/user.ts'
import { storeToRefs } from 'pinia'
import { getMyUserInfoByUserName } from '@/api/user/user.ts'
import { getLoginTypeLabel } from '@/types/user/loginLog.d.ts'
import Tags from '@/components/Tags.vue'
import { QuestionCircleOutlined } from '@ant-design/icons-vue'

const instance = getCurrentInstance()
const proxy = instance?.proxy
const { u_user_sex } = proxy?.useDict('u_user_sex')

const userStore = useUserStore()
const { userName: userName } = storeToRefs(userStore) // 使用 storeToRefs 提取响应式状态
// 模拟用户数据
const userInfo = ref<MyUserInfo>()

//获取用户信息
const getMyUserInfo = async () => {
  const res = await getMyUserInfoByUserName(userName.value)
  if (res.code === 200) {
    userInfo.value = res.data
  }
}
getMyUserInfo()

const open = ref(false)
const title = ref('修改用户信息')
const submitting = ref(false)
const formState = ref({
  nickName: '',
  sex: '0',
  occupation: '',
  introductory: '',
})

const rules = {
  nickName: [
    { required: true, message: '请输入昵称', trigger: 'blur' },
    { min: 2, max: 16, message: '长度在 2 到 16 个字符', trigger: 'blur' },
  ],
  sex: [{ required: true, message: '请选择性别', trigger: 'blur' }],

}

const handleUpdateUserInfo = () => {
  //清除原来的数据
  formState.value = {}
  formState.value = {
    ...formState.value,
    nickName: userInfo.value?.nickName || '',
    sex: userInfo.value?.sex || '0',
  }
  console.log(formState)
  open.value = true
}
//修改用户信息
const handleSubmit = async (formState) => {
  // const res = await updateMyUserInfo(formState)
  // if (res.code === 200) {
  //   message.success('修改成功')
  //   Object.assign(userInfo.value, res.data)
  // }
}
</script>

<style lang="scss" scoped>
// Variables
$primary-color: #3f51b5;
$secondary-color: #7986cb;
$background-color: #f5f7fa;
$card-bg-color: #ffffff;
$text-primary: #333333;
$text-secondary: #666666;
$text-light: #999999;
$success-color: #4caf50;
$warning-color: #ff9800;
$error-color: #f44336;
$border-radius: 12px;
$box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
$green-color: #4caf50;
$blue-color: #2196f3;
$red-color: #f44336;
$purple-color: #9c27b0;

.custom-modal-title {
  display: flex;
  align-items: center;
  font-size: 16px;

  .title-tip-icon {
    margin-left: 8px;
    color: rgba(57, 57, 57, 0.45);
    cursor: help;
    transition: color 0.3s;

    &:hover {
      color: #1890ff;
    }
  }
}

.form-footer {
  text-align: right;
  padding: 16px 0 0;
  margin-top: 24px;
  border-top: 1px solid #f0f0f0;

  .ant-btn {
    margin-left: 10px;
  }
}

.user-profile {
  max-width: 1440px;
  margin: 0 auto;
  padding: 30px 20px;
  //background-color: $background-color;
  //min-height: 100vh;
  opacity: 0;
  animation: fadeIn 2s ease forwards;

  .profile-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 40px;

    @media (min-width: 768px) {
      flex-direction: row;
      align-items: flex-start;
    }

    .avatar-section {
      margin-bottom: 30px;

      @media (min-width: 768px) {
        margin-bottom: 0;
        margin-right: 40px;
      }

      .avatar-wrapper {
        position: relative;

        .status-badge {
          position: absolute;
          bottom: 10px;
          right: 10px;
          padding: 4px 12px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 600;
          color: white;

          &.status-0 {
            background-color: $success-color;
          }

          &.status-1 {
            background-color: $warning-color;
          }

          &.status-2 {
            background-color: $error-color;
          }
        }
      }
    }

    .user-intro {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;

      .user-name {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
        color: $text-primary;
      }

      .user-occupation {
        font-size: 18px;
        color: $text-secondary;
        margin-bottom: 16px;
      }

      .user-bio {
        font-size: 16px;
        line-height: 1.6;
        color: $text-secondary;
        margin-bottom: 24px;
        //max-width: 600px;
      }

      .user-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;

        .meta-item {
          display: flex;
          align-items: center;
          color: $text-secondary;
          font-size: 14px;

          .meta-icon {
            margin-right: 8px;
            color: $secondary-color;
          }
        }
      }
    }
  }

  .profile-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 40px;

    @media (min-width: 768px) {
      grid-template-columns: repeat(4, 1fr);
    }

    .stat-card {
      background-color: $card-bg-color;
      border-radius: $border-radius;
      padding: 24px;
      text-align: center;
      box-shadow: $box-shadow;
      transition: transform 0.3s ease;

      &:hover {
        transform: translateY(-5px);
      }

      &:nth-child(1) .stat-value {
        color: $green-color; // 积分余额 - 绿色
      }

      &:nth-child(2) .stat-value {
        color: $blue-color; // 赚取积分 - 蓝色
      }

      &:nth-child(3) .stat-value {
        color: $red-color; // 使用积分 - 红色
      }

      &:nth-child(4) .stat-value {
        color: $purple-color; // 充值金额 - 紫色
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .stat-label {
        font-size: 14px;
        color: $text-secondary;
      }
    }
  }

  .profile-details {
    background-color: $card-bg-color;
    border-radius: $border-radius;
    padding: 30px;
    box-shadow: $box-shadow;

    .details-grid {
      display: grid;
      grid-template-columns: repeat(1, 1fr);
      gap: 24px;

      @media (min-width: 576px) {
        grid-template-columns: repeat(2, 1fr);
      }

      @media (min-width: 992px) {
        grid-template-columns: repeat(4, 1fr);
      }

      .detail-item {
        .detail-label {
          font-size: 14px;
          color: $text-light;
          margin-bottom: 8px;
        }

        .detail-value {
          font-size: 16px;
          color: $text-primary;
          font-weight: 500;
        }
      }
    }
  }
}

@keyframes fadeIn {
  to {
    opacity: 1;
  }
}
</style>
